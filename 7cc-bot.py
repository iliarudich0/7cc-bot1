import logging 

from telegram import Update
from telegram.ext import Application, CommandHandler, CallbackContext
import os
from dotenv import load_dotenv
from telegram import Update, InlineKeyboardButton  # üî• Add InlineKeyboardButton


# üî• Set up logging immediately after imports

logging.basicConfig(
format
=
'%(asctime)s - %(name)s - %(levelname)s - %(message)s'
, level=logging.INFO)

# Load environment variables from .env file

load_dotenv()

# –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–∑ —Ñ–∞–π–ª–∞ .env
load_dotenv()

# –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è
TOKEN = os.getenv('TOKEN')

if not TOKEN:
    raise ValueError("–¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω! –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è 'TOKEN' —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞.")


# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É–Ω–∫—Ç—ã –º–µ–Ω—é
menu_items = {
    "0": "–ú–æ–ª–∏—Ç–≤–∞ –æ —Å–µ–±–µ –∏ –æ —É—á–∞—Å—Ç–Ω–∏–∫–∞—Ö (7—Å), –∞ —Ç–∞–∫–∂–µ –æ –Ω–æ–≤—ã—Ö –º–æ–ª–∏—Ç–≤–µ–Ω–Ω–∏–∫–∞—Ö –µ—Å–ª–∏ –ì–æ—Å–ø–æ–¥—É —ç—Ç–æ —É–≥–æ–¥–Ω–æ",
    "0.1": "üî∫–ù–µ —É–ø–∞—Å—Ç—å –≤ –≥—Ä–µ—Ö –ø—Ä–µ–ª—é–±–æ–¥–µ—è–Ω–∏—è",
    "1": "1. –ò—Å–ø–æ–ª–Ω—è—Ç—å—Å—è –î—É—Ö–æ–º –°–≤—è—Ç—ã–º",
    "1.1": "1.1. –í—Å–µ–≥–¥–∞ –∑–∞ –≤—Å–µ –∫–∞—è—Ç—å—Å—è",
    "1.2": "1.2. –ü–æ—Å—Ç–æ—è–Ω–Ω–æ –±—ã—Ç—å –ø–æ—Å–ª—É—à–Ω—ã–º –ò–∏—Å—É—Å—É",
    "1.3": "1.3. –í—Å–µ–≥–¥–∞ –∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤–µ—Ä–∏—Ç—å –ò–∏—Å—É—Å—É",
    "4": "4. –ü—Ä–µ–±—ã–≤–∞—Ç—å –≤ –º–æ–ª–∏—Ç–≤–µ",
    "5": "5. –ò–∑—É—á–∞—Ç—å –°–ª–æ–≤–æ",
    "6": "6. –ò–º–µ—Ç—å –æ–±—â–µ–Ω–∏–µ —Å–æ —Å–≤—è—Ç—ã–º–∏",
    "7": "7. –°–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–æ–≤–∞—Ç—å –æ–± –ò–∏—Å—É—Å–µ"
}

# –í–æ–ø—Ä–æ—Å—ã –ø–æ –∫–∞–∂–¥–æ–º—É –ø—É–Ω–∫—Ç—É
questions = {
    "0": ["–í—ã –º–æ–ª–∏–ª–∏—Å—å –æ —Å–µ–±–µ –∏ –æ–± —É—á–∞—Å—Ç–Ω–∏–∫–∞—Ö –≥—Ä—É–ø–ø—ã?", "–í—ã –ø—Ä–æ—Å–∏–ª–∏ –ë–æ–≥–∞ –ø–æ—Å–ª–∞—Ç—å –µ—â–µ –º–æ–ª–∏—Ç–≤–µ–Ω–Ω–∏–∫–æ–≤?"],
    "0.1": ["–í—ã –º–æ–ª–∏–ª–∏—Å—å –æ —Ç–æ–º, —á—Ç–æ–±—ã –ë–æ–≥ –≤—Å–µ–ª–∏–ª –≤ –≤–∞—Å –∏ –≤ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —ç—Ç–æ–π –≥—Ä—É–ø–ø—ã –≤–µ–ª–∏–∫–∏–π —Å—Ç—Ä–∞—Ö –ø–µ—Ä–µ–¥ –≥—Ä–µ—Ö–æ–º –ø—Ä–µ–ª—é–±–æ–¥–µ—è–Ω–∏—è?", "–í—ã –ø–æ—Å—Ç–∏–ª–∏—Å—å –ø–æ —ç—Ç–æ–π —Ç–µ–º–µ?"],
    "1": ["–í—ã —Å—Ç—Ä–µ–º–∏–ª–∏—Å—å –∏—Å–ø–æ–ª–Ω–∏—Ç—å—Å—è –î—É—Ö–æ–º –°–≤—è—Ç—ã–º —Å–µ–≥–æ–¥–Ω—è?", "–ò—Å–ø–æ–ª–Ω—è–ª–∏ –ª–∏ –≤—ã 3 –∑–∞–∫–æ–Ω–∞ –¥—É—Ö–æ–≤–Ω–æ–π –∂–∏–∑–Ω–∏?"],
    "1.1": ["–í—ã –∫–∞—è–ª–∏—Å—å —Å–µ–≥–æ–¥–Ω—è –∑–∞ —Å–≤–æ–∏ –≥—Ä–µ—Ö–∏?", "–ö–∞–∫–∏–µ –≥—Ä–µ—Ö–∏ –∏—Å–ø–æ–≤–µ–¥–æ–≤–∞–ª–∏ –ø—Ä–µ–¥ –ë–æ–≥–æ–º –∏ –ª—é–¥—å–º–∏?"],
    "1.2": ["–ë—ã–ª–∏ –ª–∏ –≤—ã –ø–æ—Å–ª—É—à–Ω—ã –ò–∏—Å—É—Å—É —Å–µ–≥–æ–¥–Ω—è?", "–ß—Ç–æ –≤ÔøΩÔøΩ —Å–¥–µ–ª–∞–ª–∏, —á—Ç–æ–±—ã –ø–æ–¥—á–∏–Ω–∏—Ç—å—Å—è –≤–æ–ª–µ –ò–∏—Å—É—Å–∞ —Å–µ–≥–æ–¥–Ω—è?"],
    "1.3": ["–í—ã –≤–µ—Ä–∏—Ç–µ –ò–∏—Å—É—Å—É –≤–æ –≤—Å–µ–º?", "–í—ã –¥–æ–≤–µ—Ä—è–ª–∏ –ë–æ–≥—É —Å–µ–≥–æ–¥–Ω—è –≤ —Å–≤–æ–∏—Ö –¥–µ–ª–∞—Ö –∏ –º—ã—Å–ª—è—Ö?"],
    "4": ["–í—ã –º–æ–ª–∏–ª–∏—Å—å —Å–µ–≥–æ–¥–Ω—è?", "–ö–∞–∫ –¥–æ–ª–≥–æ –≤—ã –ø—Ä–µ–±—ã–≤–∞–ª–∏ –≤ –º–æ–ª–∏—Ç–≤–µ?"],
    "5": ["–í—ã –∏–∑—É—á–∞–ª–∏ –°–ª–æ–≤–æ —Å–µ–≥–æ–¥–Ω—è?", "–ö–∞–∫—É—é —á–∞—Å—Ç—å –ü–∏—Å–∞–Ω–∏—è –≤—ã –ø—Ä–æ—á–∏—Ç–∞–ª–∏ —Å–µ–≥–æ–¥–Ω—è?"],
    "6": ["–í—ã –∏–º–µ–ª–∏ –æ–±—â–µ–Ω–∏–µ —Å–æ —Å–≤—è—Ç—ã–º–∏ —Å–µ–≥–æ–¥–Ω—è?", "–° –∫–µ–º –∏–∑ –±—Ä–∞—Ç—å–µ–≤ –∏ —Å–µ—Å—Ç–µ—Ä –≤—ã —Å–µ–≥–æ–¥–Ω—è –æ–±—â–∞–ª–∏—Å—å?"],
    "7": ["–í—ã —Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–æ–≤–∞–ª–∏ –æ–± –ò–∏—Å—É—Å–µ —Å–µ–≥–æ–¥–Ω—è?", "–ö–æ–º—É –≤—ã —Ä–∞—Å—Å–∫–∞–∑–∞–ª–∏ –æ–± –ò–∏—Å—É—Å–µ —Å–µ–≥–æ–¥–Ω—è?"],
}

# –°–ª–æ–≤–∞—Ä—å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
user_last_message = {}

# –ö–æ–º–∞–Ω–¥–∞ /start
def start(update: Update, context: CallbackContext) -> None:
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ—Å–Ω–æ–≤–Ω–æ–µ –º–µ–Ω—é –ø–æ—Å–ª–µ –∫–æ–º–∞–Ω–¥—ã /start –∏ —É–¥–∞–ª—è–µ—Ç –≤—Å–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è"""
    chat_id = update.message.chat_id

    # –£–¥–∞–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    try:
        context.bot.delete_message(chat_id=chat_id, message_id=update.message.message_id)
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è /start: {e}")
    
    # –£–¥–∞–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏
    if chat_id in user_last_message:
        try:
            context.bot.delete_message(chat_id=chat_id, message_id=user_last_message[chat_id])
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –º–µ–Ω—é
    reply_markup = build_menu()
    message = context.bot.send_message(chat_id=chat_id, text="–ù–∞—á–Ω–∏—Ç–µ –ø—Ä–æ–≤–µ—Ä–∫—É, –≤—ã–±–µ—Ä–∏—Ç–µ –ø—É–Ω–∫—Ç –∏–∑ –º–µ–Ω—é –Ω–∏–∂–µ:", reply_markup=reply_markup)
    user_last_message[chat_id] = message.message_id  # –°–æ—Ö—Ä–∞–Ω—è–µ–º ID —Å–æ–æ–±—â–µ–Ω–∏—è

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –º–µ–Ω—é
def build_menu():
    """–°–æ–∑–¥–∞–µ—Ç –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –ø—É–Ω–∫—Ç–∞–º–∏ –º–µ–Ω—é"""
    keyboard = []
    for key, value in menu_items.items():
        keyboard.append([InlineKeyboardButton(value, callback_data=key)])
    return InlineKeyboardMarkup(keyboard)

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏–π –Ω–∞ –∫–Ω–æ–ø–∫–∏
def button_handler(update: Update, context: CallbackContext) -> None:
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –º–µ–Ω—é"""
    query = update.callback_query
    query.answer()
    
    # –ü–æ–ª—É—á–∞–µ–º –∫–ª—é—á –ø—É–Ω–∫—Ç–∞ –º–µ–Ω—é, –ø–æ –∫–æ—Ç–æ—Ä–æ–º—É –Ω–∞–∂–∞–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    selected_item = query.data
    item_title = menu_items.get(selected_item, "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø—É–Ω–∫—Ç")
    
    # –°–æ–∑–¥–∞–µ–º —Ç–µ–∫—Å—Ç —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –ø—É–Ω–∫—Ç—É
    if selected_item in questions:
        question_list = questions[selected_item]
        message_text = f"<b>{item_title}</b>\n\n–ó–∞–¥–∞–π—Ç–µ —Å–µ–±–µ —ç—Ç–∏ –≤–æ–ø—Ä–æ—Å—ã, –∏ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –∫ —Å–ª–µ–¥—É—é—â–∏–º –ø—ÉÔøΩÔøΩ–∫—Ç–∞–º.:"
        for i, question in enumerate(question_list, start=1):
            message_text += f"\n{i}. <i>{question}</i>"
    else:
        message_text = "–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –≤–æ–ø—Ä–æ—Å—ã –ø–æ —ç—Ç–æ–º—É –ø—É–Ω–∫—Ç—É."

    # –î–æ–±–∞–≤–ª—è–µ–º –º–µ–Ω—é –≤ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏
    message_text += "\n\n<b>–í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–π –ø—É–Ω–∫—Ç –∏–∑ –º–µ–Ω—é –Ω–∏–∂–µ:</b>"
    reply_markup = build_menu()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –ª–∏ –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ
    if query.message.text != message_text or query.message.reply_markup != reply_markup:
        query.edit_message_text(text=message_text, reply_markup=reply_markup, parse_mode='HTML')

def main() -> None:
    # –°–æ–∑–¥–∞–µ–º Updater –∏ –ø–µ—Ä–µ–¥–∞–µ–º –µ–º—É —Ç–æ–∫–µ–Ω –≤–∞—à–µ–≥–æ –±–æ—Ç–∞
    updater = Updater(TOKEN)

    # –ü–æ–ª—É—á–∞–µ–º –¥–∏—Å–ø–µ—Ç—á–µ—Ä –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
    dispatcher = updater.dispatcher

    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    dispatcher.add_handler(CommandHandler("start", start))
    dispatcher.add_handler(CallbackQueryHandler(button_handler))

    # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
    updater.start_polling()

    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–æ—Ç–∞ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ Ctrl-C –∏–ª–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–∏–≥–Ω–∞–ª–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
    updater.idle()

if __name__ == "__main__":
    logging.info("Bot started. Configuring handlers and starting polling.")
    
    # Create the bot application instance
   async def post_init(application: Application) -> None:
    await application.bot.delete_webhook()
    logging.info("Webhook deleted successfully.")


    # Run polling with drop_pending_updates to clear old messages
    try:
        application.run_polling(drop_pending_updates=True)
    